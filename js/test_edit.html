<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Edit Test</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body>
    <div class="container mt-4">
        <h1>Edit Button Test</h1>
        <button class="btn btn-primary" onclick="testEdit()">Test Edit Function</button>
        
        <div class="mt-4">
            <h3>Sample Book</h3>
            <div class="book-item" data-book-data='{"id":"test123","name":"Test Book","author":"Test Author","type":"physical","status":"unread","rating":0,"notes":""}'>
                <button class="btn btn-sm btn-outline-primary edit-book">
                    <i class="fas fa-edit"></i> Edit
                </button>
            </div>
        </div>
    </div>

    <!-- Edit Book Modal -->
    <div class="modal fade" id="editBookModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Edit Book</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="editBookForm">
                        <input type="hidden" id="editBookId">
                        <div class="row">
                            <div class="col-md-6">
                                <label for="editBookTitle" class="form-label">Title</label>
                                <input type="text" class="form-control" id="editBookTitle" required>
                            </div>
                            <div class="col-md-6">
                                <label for="editBookAuthor" class="form-label">Author</label>
                                <input type="text" class="form-control" id="editBookAuthor" required>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-4">
                                <label for="editBookType" class="form-label">Type</label>
                                <select class="form-select" id="editBookType">
                                    <option value="physical">Physical Book</option>
                                    <option value="kindle">Kindle</option>
                                    <option value="audible">Audible</option>
                                    <option value="ebook">E-Book</option>
                                </select>
                            </div>
                            <div class="col-md-4">
                                <label for="editBookStatus" class="form-label">Status</label>
                                <select class="form-select" id="editBookStatus">
                                    <option value="unread">Unread</option>
                                    <option value="reading">Currently Reading</option>
                                    <option value="completed">Completed</option>
                                    <option value="abandoned">Abandoned</option>
                                    <option value="want_to_read">Want to Read</option>
                                </select>
                            </div>
                            <div class="col-md-4">
                                <label for="editBookRating" class="form-label">Rating</label>
                                <select class="form-select" id="editBookRating">
                                    <option value="0">No Rating</option>
                                    <option value="1">1 Star</option>
                                    <option value="2">2 Stars</option>
                                    <option value="3">3 Stars</option>
                                    <option value="4">4 Stars</option>
                                    <option value="5">5 Stars</option>
                                </select>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-12">
                                <label for="editBookNotes" class="form-label">Personal Notes</label>
                                <textarea class="form-control" id="editBookNotes" rows="3"></textarea>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" id="saveBookChanges">Save Changes</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script>
        $(document).ready(function() {
            console.log('Test page loaded');
            
            // Initialize modal
            const editModal = new bootstrap.Modal(document.getElementById('editBookModal'));
            
            // Setup edit button
            $('.edit-book').on('click', function(e) {
                e.preventDefault();
                console.log('Edit button clicked');
                const bookItem = $(this).closest('.book-item');
                const bookData = JSON.parse(bookItem.data('book-data'));
                console.log('Book data:', bookData);
                openEditModal(bookData);
            });
            
            // Setup save button
            $('#saveBookChanges').on('click', function() {
                console.log('Save button clicked');
                saveBookChanges();
            });
        });
        
        function openEditModal(book) {
            console.log('Opening edit modal for book:', book);
            $('#editBookId').val(book.id);
            $('#editBookTitle').val(book.name);
            $('#editBookAuthor').val(book.author);
            $('#editBookType').val(book.type);
            $('#editBookStatus').val(book.status);
            $('#editBookRating').val(book.rating || 0);
            $('#editBookNotes').val(book.notes || '');
            
            const modal = new bootstrap.Modal(document.getElementById('editBookModal'));
            modal.show();
        }
        
        function saveBookChanges() {
            console.log('Saving book changes...');
            const bookData = {
                id: $('#editBookId').val(),
                name: $('#editBookTitle').val(),
                author: $('#editBookAuthor').val(),
                type: $('#editBookType').val(),
                status: $('#editBookStatus').val(),
                rating: parseInt($('#editBookRating').val()) || 0,
                notes: $('#editBookNotes').val()
            };
            
            console.log('Book data to save:', bookData);
            
            // Test the API call
            $.ajax({
                url: '/books',
                method: 'PUT',
                contentType: 'application/json',
                data: JSON.stringify({
                    book: bookData,
                    key: ''
                }),
                success: function(response) {
                    console.log('Book updated successfully:', response);
                    alert('Book updated successfully!');
                    const modal = bootstrap.Modal.getInstance(document.getElementById('editBookModal'));
                    if (modal) {
                        modal.hide();
                    }
                },
                error: function(xhr, status, error) {
                    console.error('Failed to update book:', error);
                    alert('Failed to update book: ' + error);
                }
            });
        }
        
        function testEdit() {
            const testBook = {
                id: "test123",
                name: "Test Book",
                author: "Test Author",
                type: "physical",
                status: "unread",
                rating: 0,
                notes: ""
            };
            openEditModal(testBook);
        }
    </script>
</body>
</html>
